# Сервис Stock Bot

**Stock Bot** — это Telegram-бот, который слушает события из Google Cloud Pub/Sub и отправляет уведомления в групповой чат Telegram о низких остатках товаров, получении FBO-поставок и превышении остатков FBO на маркетплейсах Ozon и Wildberries. Бот работает как асинхронный consumer, обрабатывающий сообщения из трех подписок Pub/Sub.

## Функциональные возможности

- **Уведомления о низких остатках**: Отправка сообщений в Telegram при получении событий из подписки `low_on_stock_sub`.
- **Уведомления о получении FBO**: Сообщения о получении поставок на склад FBO из подписки `fbo_received-sub`.
- **Уведомления о превышении FBO**: Сообщения о превышении остатков FBO из подписки `fbo_over-sub`.
- **Поддержка маркетплейсов**: Работа с Ozon и Wildberries для разных юридических лиц (ООО "Орион", ООО "Строй-Отделка", ООО "Амодекор", ООО "Драйв", ООО "Центурион СПб").
- **Асинхронная обработка**: Использование `asyncio` для параллельного прослушивания событий.
- **Логирование**: Логи уровня `INFO` и выше для отслеживания обработки событий и ошибок.

## Начало работы

Для запуска бота необходимо настроить окружение, установить зависимости и запустить его локально или в контейнере Docker.

### Настройка локально

1. **Создание виртуального окружения**:
   Создайте виртуальное окружение с помощью Poetry:
   ```bash
   poetry env use python3.11
   ```
   
   - Активируйте его:
       ```
      poetry shell
      ```
   
2. **Установка зависимостей: Установите зависимости через Poetry:**
    ```
   poetry install
   ```
   
3. **Настройка переменных окружения: Скопируйте файл .env-example в .env и заполните его:**
    ```
   cp .env-example .env
   ```
   
4. **Запуск бота: Запустите бота локально:**
    ```
   python main.py
   ```
   
## Запуск в Docker
1. **Сборка Docker-образа: Соберите образ из Dockerfile:**
    ```
   docker build -t stock-bot .
   ```
   
2. **Запуск контейнера: Запустите контейнер, монтируя конфигурацию Google Cloud и .env:**
    ```
   docker run -d \
    --name stock-bot \
    -v ~/.config/gcloud:/root/.config/gcloud \
    --env-file .env \
    stock-bot
   ```
   
3. **Просмотр логов: Проверьте логи контейнера:**
    ```
   docker logs stock-bot
   ```
   
## Дополнительная информация
**Pub/Sub подписки:**
- low_on_stock_sub: Уведомления о низких остатках.
- fbo_received-sub: Уведомления о получении FBO-поставок.
- fbo_over-sub: Уведомления о превышении FBO-остатков.

**Telegram API**: Используется https://api.telegram.org/bot<token>/sendMessage для отправки сообщений.

**Темы в чате**: Уведомления отправляются в определенные темы (threads) в зависимости от маркетплейса, юридического лица и типа события.