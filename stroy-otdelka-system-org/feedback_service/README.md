# Сервис Feedback Service

Сервис **Feedback Service** предназначен для автоматизации работы с отзывами и вопросами на маркетплейсах (*Wildberries*, *Ozon*, *Яндекс.Маркет*). Он собирает неотвеченные отзывы и вопросы, определяет их тональность с помощью OpenAI, генерирует ответы и отправляет их через API или Selenium. Сервис работает как standalone-приложение с использованием асинхронной обработки и многопроцессорности.

## Функциональные возможности

- **Сбор отзывов и вопросов**: Получение неотвеченных отзывов и вопросов с *Wildberries*, *Ozon* и *Яндекс.Маркет*.
- **Хранение данных**: Сохранение отзывов и вопросов в PostgreSQL с использованием SQLAlchemy.
- **Определение тональности**: Анализ тональности отзывов через OpenAI.
- **Генерация ответов**: Автоматическое создание текстов ответов с помощью OpenAI.
- **Отправка ответов**:
  - *Wildberries*: Через API.
  - *Ozon*: Через Selenium с использованием Pub/Sub для асинхронной обработки.
  - *Яндекс.Маркет*: Через Selenium.
- **Оркестрация процессов**: Использование многопроцессорности (`multiprocessing`) для параллельной обработки поставщиков и маркетплейсов.
- **Логирование**: Подробное логирование с интеграцией в Google Cloud Logging.
- **Обработка ошибок**: Механизмы повторных попыток (`backoff`) и rollback через Pub/Sub для *Ozon*.

## Начало работы

Для запуска сервиса необходимо установить зависимости, настроить окружение и запустить процессы сбора данных.

### Настройка локально

1. **Установка системных зависимостей**:

   Убедитесь, что у вас установлены необходимые пакеты:
   ```bash
   apt update -y && apt install -y \
       wget \
       xvfb \
       software-properties-common \
       build-essential \
       google-chrome-stable \
       ffmpeg
    ```
   
2. **Создание виртуального окружения:**
    - Используйте Poetry для создания окружения:
   ```
    poetry env use python3.12
    poetry shell
   ```

3. **Установка зависимостей:**
    - Установите зависимости через Poetry:
   ```
   poetry install
   ```

4. **Настройка переменных окружения:**
    - Скопируйте .env-example в .env и заполните его:
   ```
   cp .env-example .env
   ```


5. **Инициализация базы данных:**
    - Примените миграции через Alembic:
   ```
    alembic upgrade head
   ```

## Деплой в Docker

- **Сборка и запуск:**
    ```
    docker build -t feedback-service .
    docker run -d --env-file .env feedback-service
  ```
  
## Дополнительная информация
- База данных: Используется PostgreSQL с асинхронным драйвером asyncpg. Модели определены через SQLAlchemy.


- Selenium: Применяется для Ozon и Яндекс.Маркет. Используется undetected-chromedriver для обхода защиты.


- Pub/Sub: Для Ozon реализована асинхронная отправка ответов через Google Cloud Pub/Sub с rollback-механизмом.


- OpenAI: Используется для анализа тональности и генерации ответов через прокси-URL (URL_PROXY_OPENAI).


- Многопроцессорность: Каждый поставщик обрабатывается в отдельном процессе для повышения производительности.


- Логи: Интеграция с Google Cloud Logging для мониторинга.
